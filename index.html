<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bike Safety Analysis Tool</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        
        .controls { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            margin-bottom: 25px; 
        }

        .control-sections {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-items: flex-start;
        }

        .section-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            border-left: 3px solid #e0e0e0;
            padding-left: 20px;
        }
        
        .section-group:first-child { border-left: none; padding-left: 0; }

        .control-item { display: flex; flex-direction: column; gap: 5px; }
        
        label { font-weight: 700; font-size: 0.95rem; color: #444; margin-bottom: 2px; }
        .sub-label { font-size: 0.85rem; color: #666; font-weight: 600; }

        input[type="text"], input[type="number"], select { 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 6px;
        }
        input[type="text"] { width: 300px; }
        input[type="number"] { width: 140px; }
        select { width: 220px; cursor: pointer; }
        input[type="range"] { width: 150px; cursor: pointer; }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 35px; 
        }
        .checkbox-wrapper input { width: 18px; height: 18px; cursor: pointer; }

        .btn-group { display: flex; }
        .btn-group button {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-group button:first-child { border-radius: 6px 0 0 6px; }
        .btn-group button:last-child { border-radius: 0 6px 6px 0; border-left: none; }
        .btn-group button:not(:first-child):not(:last-child) { border-left: none; }
        .btn-group button:hover { background-color: #e2e6ea; }
        
        .btn-group button.active-infra { background-color: #198754 !important; border-color: #198754 !important; color: white; }
        .btn-group button.active-balanced { background-color: #6f42c1 !important; border-color: #6f42c1 !important; color: white; }
        .btn-group button.active-dest { background-color: #0d6efd !important; border-color: #0d6efd !important; color: white; }
        .btn-group button.active { background-color: #6c757d; color: white; border-color: #6c757d; }

        .action-btn {
            padding: 10px 20px;
            background-color: #198754;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        .action-btn:hover { background-color: #157347; }
        
        .mode-toggle-btn {
            background-color: #0d6efd;
            width: 100%;
        }
        .mode-toggle-btn:hover { background-color: #0b5ed7; }

        #chart-container, #map-container { 
            width: 100%; 
            max-width: 2300px; /* CHANGED: Scales up for ultrawides */
            height: 70vh; /* CHANGED: Scales vertically based on viewport */
            min-height: 500px; /* CHANGED: Stays usable on mobile */
            max-height: 1100px; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            padding: 10px;
            box-sizing: border-box;
            margin: 0 auto;
        }
        
        #map-container { display: none; }

        #list-view-container {
            display: none; 
            width: 100%;
            background: #f0f2f5;
        }

        .list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .list-card {
            background: white;
            padding: 0; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            max-height: 500px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .list-card h3 {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            margin: 0;
            padding: 15px 15px 10px 15px; 
            font-size: 1.0rem; 
            border-bottom: 2px solid #eee;
            color: #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-card h3 select {
            font-size: 0.85rem;
            padding: 4px;
            width: auto;      
            max-width: 140px; 
            margin-left: 5px;
            font-weight: normal;
        }
        
        .sort-btn {
            padding: 4px 8px;
            margin-left: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }
        .sort-btn:hover { background: #dee2e6; color: #333; }
        .sort-btn.active-sort { background: #0d6efd; color: white; border-color: #0d6efd; }

        table.ranking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        table.ranking-table th { text-align: left; color: #666; font-size: 0.8rem; padding: 5px 15px; border-bottom: 1px solid #ddd; }
        table.ranking-table td { padding: 6px 15px; border-bottom: 1px solid #f5f5f5; }
        table.ranking-table tr:last-child td { border-bottom: none; }
        table.ranking-table tr:nth-child(even) { background-color: #fafafa; }
        
        .rank-col { width: 30px; font-weight: bold; color: #888; }
        .val-col { text-align: right; font-weight: 600; color: #0d6efd; }
        .city-sub { font-size: 0.8em; color: #999; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="controls">
        <div class="control-sections">
            <div class="section-group">
                <div class="control-item">
                    <label>1. Select Data Source</label>
                    <input type="file" id="csvFile" accept=".csv">
                </div>
                <div class="control-item">
                     <button class="action-btn mode-toggle-btn" id="viewToggleBtn" onclick="cycleView()">Switch to Map View</button>
                </div>
            </div>

            <div class="section-group">
                <div class="control-item">
                    <label>2. Graph Title</label>
                    <input type="text" id="graphTitle" value="City Bike Performance: Avg Score vs Best Area">
                </div>
                <div class="control-item">
                    <button class="action-btn" onclick="downloadChart()">Download Chart Image</button>
                </div>
            </div>

            <div class="section-group" style="flex: 1;">
                <label>3. Global Options</label>
                
                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    <div class="control-item">
                        <span class="sub-label">Focus</span>
                        <div class="btn-group" id="focusButtons">
                            <button onclick="setFocus('Infrastructure')">Infrastructure</button>
                            <button class="active-balanced" onclick="setFocus('Balanced')">Balanced</button>
                            <button onclick="setFocus('Destination')">Destination</button>
                        </div>
                    </div>

                    <div class="control-item">
                        <span class="sub-label">Min Population</span>
                        <input type="number" id="minPop" value="0" min="0" max="10000000" 
                            step="1000" placeholder="e.g. 100000"
                            oninput="handlePopChange(this)">
                    </div>
                    
                    <div id="agg-control" class="control-item">
                        <span class="sub-label">Data Aggregation</span>
                        <select id="aggFilter" onchange="updateView()">
                            <option value="City Wide">City Wide</option>
                            <option value="Best Area">Best Area</option>
							<option value="Highest Point">Highest Point</option>
                        </select>
                    </div>

                    <div id="map-control" class="control-item hidden">
                        <span class="sub-label">Map Level</span>
                        <select id="mapLevel" onchange="updateView()">
                            <option value="Country">Country (Best City)</option>
                            <option value="State">Hybrid (World + US States)</option>
                            <option value="City">City Bubbles</option>
                        </select>
                    </div>

                    <div class="control-item">
                        <span class="sub-label">Region Filter</span>
                        <select id="regionFilter" onchange="updateView()">
                            <option value="All">All Regions</option>
                            <option value="North America">North America</option>
                            <option value="Europe">Europe</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div id="graph-options" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; display: flex; gap: 20px;">
                    <div class="control-item">
                        <span class="sub-label">Graph Labels</span>
                        <div class="btn-group" id="labelButtons">
                            <button class="active" onclick="setLabelMode('None')">None</button>
                            <button onclick="setLabelMode('Pop')">Top 25 Pop</button>
                            <button onclick="setLabelMode('Score')">Top 25 Score</button>
                        </div>
                    </div>

                    <div class="control-item">
                        <span class="sub-label">Point Scaling</span>
                        <input type="range" id="sizeSlider" min="0" max="100" value="100">
                    </div>

                    <div class="control-item" style="justify-content: center;">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="forceCircle">
                            <span class="sub-label">Force Circles</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-container"></div>
    
    <div id="map-container"></div>

    <div id="list-view-container">
        <div class="list-grid" id="listGrid"></div>
    </div>

    <script>
        // --- CUSTOM COLOR SCALE (Red -> Orange -> Yellow -> Green) ---
        // Domain 0.0-1.0 maps to score 0-100 roughly. 
        // 0-25: Red, 25-50: Orange, 50-80: Light Green, 80+: Dark Green
        const CUSTOM_COLORSCALE = [
			[0.0, '#8b0000'], // Dark Red
            [0.2, '#d73027'], // Red
            [0.4, '#c97d32'], // Orange
            [0.55, '#ccba47'], // Yellow
            [0.7, '#d9ef8b'], // Light Greenish
            [0.9, '#91cf60'],// Green
            [1.0, '#1a9850']  // Dark Green
        ];

        // --- UPDATED MASTER COORDINATE DICTIONARY ---
        // Replaces the existing CITY_COORDS variable
        const CITY_COORDS = {
            // ORIGINAL CITIES
            "The Hague, Netherlands": {lat:52.0705, lon:4.3007},
            "Rotterdam, Netherlands": {lat:51.9225, lon:4.4792},
            "Helsinki, Finland": {lat:60.1699, lon:24.9384},
            "Stockholm, Sweden": {lat:59.3293, lon:18.0686},
            "Cologne, Germany": {lat:50.9375, lon:6.9603},
            "Munich, Germany": {lat:48.1351, lon:11.5820},
            "Vienna, Austria": {lat:48.2082, lon:16.3738},
            "Brussels, Belgium": {lat:50.8503, lon:4.3517},
            "Barcelona, Spain": {lat:41.3851, lon:2.1734},
            "Bonn, Germany": {lat:50.7374, lon:7.0982},
            "Utrecht, Netherlands": {lat:52.0907, lon:5.1214},
            "Frankfurt, Germany": {lat:50.1109, lon:8.6821},
            "Antwerp, Belgium": {lat:51.2194, lon:4.4025},
            "Strasbourg, France": {lat:48.5734, lon:7.7521},
            "Eindhoven, Netherlands": {lat:51.4416, lon:5.4697},
            "Wroclaw, Poland": {lat:51.1079, lon:17.0385},
            "Münster, Germany": {lat:51.9607, lon:7.6261},
            "Stuttgart, Germany": {lat:48.7758, lon:9.1829},
            "Nuremberg, Germany": {lat:49.4521, lon:11.0767},
            "Malmo, Sweden": {lat:55.6049, lon:13.0038},
            "Freiburg, Germany": {lat:47.9990, lon:7.8421},
            "Essen, Germany": {lat:51.4556, lon:7.0116},
            "Warsaw, Poland": {lat:52.2297, lon:21.0122},
            "Valencia, Spain": {lat:39.4699, lon:-0.3763},
            "Duisburg, Germany": {lat:51.4344, lon:6.7623},
            "Zurich, Switzerland": {lat:47.3769, lon:8.5417},
            "Groningen, Netherlands": {lat:53.2194, lon:6.5665},
            "Bordeaux, France": {lat:44.8378, lon:-0.5792},
            "Lodz, Poland": {lat:51.7592, lon:19.4560},
            "Nantes, France": {lat:47.2184, lon:-1.5536},
            "Ghent, Belgium": {lat:51.0543, lon:3.7174},
            "Seville, Spain": {lat:37.3891, lon:-5.9845},
            "Krakow, Poland": {lat:50.0647, lon:19.9450},
            "Bologna, Italy": {lat:44.4949, lon:11.3426},
            "Edinburgh, UK": {lat:55.9533, lon:-3.1883},
            "Bratislava, Slovakia": {lat:48.1486, lon:17.1077},
            "Lisbon, Portugal": {lat:38.7223, lon:-9.1393},
            "Milan, Italy": {lat:45.4642, lon:9.1900},
            "Madrid, Spain": {lat:40.4168, lon:-3.7038},
            "Birmingham, UK": {lat:52.4862, lon:-1.8904},
            "Milton Keynes, United Kingdom": {lat:52.0406, lon:-0.7594},
            "Dortmund, Germany": {lat:51.5136, lon:7.4653},
            "Manchester, United Kingdom": {lat:53.4808, lon:-2.2426},
            "Florence, Italy": {lat:43.7696, lon:11.2558},
            "Ljubljana, Slovenia": {lat:46.0569, lon:14.5058},
            "Vitoria-Gasteiz, Spain": {lat:42.8467, lon:-2.6716},
            "Prague, Czechia": {lat:50.0755, lon:14.4378},
            "Athens, Greece": {lat:37.9838, lon:23.7275},
            "Oulu, Finland": {lat:65.0121, lon:25.4651},
            "Leeds, UK": {lat:53.8008, lon:-1.5491},
            "Bucharest, Romania": {lat:44.4268, lon:26.1025},
            "Sofia, Bulgaria": {lat:42.6977, lon:23.3219},
            "Belgrade, Serbia": {lat:44.7866, lon:20.4489},
            "Naples, Italy": {lat:40.8518, lon:14.2681},
            "Rome, Italy": {lat:41.9028, lon:12.4964},
            "Paris, France": {lat:48.8566, lon:2.3522},
            "Berlin, Germany": {lat:52.5200, lon:13.4050},
            "Amsterdam, Netherlands": {lat:52.3676, lon:4.9041},
            "Copenhagen, Denmark": {lat:55.6761, lon:12.5683},
            "London, UK": {lat:51.5074, lon:-0.1278},
            "Hamburg, Germany": {lat:53.5511, lon:9.9937},
            "Oslo, Norway": {lat:59.9139, lon:10.7522},
            "Bogota, Colombia": {lat:4.7110, lon:-74.0721},
            "Montreal, QC": {lat:45.5017, lon:-73.5673},
            "Vancouver, BC": {lat:49.2827, lon:-123.1207},
            "Santiago, Chile": {lat:-33.4489, lon:-70.6693},
            "Edmonton, AB": {lat:53.5461, lon:-113.4938},
            "Calgary, AB": {lat:51.0447, lon:-114.0719},
            "Buenos Aires, Argentina": {lat:-34.6037, lon:-58.3816},
            "Guadalajara, Mexico": {lat:20.6597, lon:-103.3496},
            "Quebec City, QC": {lat:46.8139, lon:-71.2080},
            "Porto, Portugal": {lat:41.1579, lon:-8.6291},
            "Curitiba, Brazil": {lat:-25.4284, lon:-49.2733},
            "Rosario, Argentina": {lat:-32.9442, lon:-60.6505},
            "Mexico City, Mexico": {lat:19.4326, lon:-99.1332},
            "Medellín, Colombia": {lat:6.2442, lon:-75.5812},
            "Recife, Brazil": {lat:-8.0476, lon:-34.8770},
            "Montevideo, Uruguay": {lat:-34.9011, lon:-56.1645},
            "Toronto, ON": {lat:43.6532, lon:-79.3832},
            "Ottawa, ON": {lat:45.4215, lon:-75.6972},
            "Canberra, ACT": {lat:-35.2809, lon:149.1300},
            "Tel Aviv, Israel": {lat:32.0853, lon:34.7818},
            "Seoul, South Korea": {lat:37.5665, lon:126.9780},
            "Taipei, Taiwan": {lat:25.0330, lon:121.5654},
            "Singapore, Singapore": {lat:1.3521, lon:103.8198},
            "Daejeon, South Korea": {lat:36.3504, lon:127.3845},
            "Osaka, Japan": {lat:34.6937, lon:135.5023},
            "Metro Manila, Philippines": {lat:14.5995, lon:120.9842},
            "Kyoto, Japan": {lat:35.0116, lon:135.7681},
            "Adelaide, SA": {lat:-34.9285, lon:138.6007},
            "Kuala Lumpur, Malaysia": {lat:3.1390, lon:101.6869},
            "Tbilisi, Georgia": {lat:41.7151, lon:44.8271},
            "Bengaluru, India": {lat:12.9716, lon:77.5946},
            "Fukuoka, Japan": {lat:33.5902, lon:130.4017},
            "Hong Kong, China": {lat:22.3193, lon:114.1694},
            "Marrakech, Morocco": {lat:31.6295, lon:-7.9811},
            "Changwon, South Korea": {lat:35.2279, lon:128.6811},
            "Nairobi, Kenya": {lat:-1.2921, lon:36.8219},
            "Bangkok, Thailand": {lat:13.7563, lon:100.5018},
            "Addis Ababa, Ethiopia": {lat:9.0331, lon:38.7444},
            "Hanoi, Vietnam": {lat:21.0285, lon:105.8542},
            "Kigali, Rwanda": {lat:-1.9441, lon:30.0619},
            "Windhoek, Namibia": {lat:-22.5609, lon:17.0658},
            "Minneapolis, MN": {lat:44.9778, lon:-93.2650},
            "St Paul, MN": {lat:44.9537, lon:-93.0900},
            "Manhattan, NY": {lat:40.7831, lon:-73.9712},
            "Arlington, VA": {lat:38.8799, lon:-77.1067},
            "Washington, DC": {lat:38.9072, lon:-77.0369},
            "Seattle, WA": {lat:47.6062, lon:-122.3321},
            "Boston, MA": {lat:42.3601, lon:-71.0589},
            "Denver, CO": {lat:39.7392, lon:-104.9903},
            "Brooklyn, NY": {lat:40.6782, lon:-73.9442},
            "Salt Lake City, UT": {lat:40.7608, lon:-111.8910},
            "Portland, OR": {lat:45.5152, lon:-122.6784},
            "Irvine, CA": {lat:33.6846, lon:-117.8265},
            "Madison, WI": {lat:43.0731, lon:-89.4012},
            "San Francisco, CA": {lat:37.7749, lon:-122.4194},
            "New York, NY": {lat:40.7128, lon:-74.0060},
            "Baltimore, MD": {lat:39.2904, lon:-76.6122},
            "Anchorage, AK": {lat:61.2181, lon:-149.9003},
            "Chicago, IL": {lat:41.8781, lon:-87.6298},
            "The Bronx, NY": {lat:40.8448, lon:-73.8648},
            "Long Beach, CA": {lat:33.7701, lon:-118.1937},
            "Lincoln, NE": {lat:40.8136, lon:-96.7026},
            "Milwaukee, WI": {lat:43.0389, lon:-87.9065},
            "St. Louis, MO": {lat:38.6270, lon:-90.1994},
            "Omaha, NE": {lat:41.2565, lon:-95.9345},
            "Philadelphia, PA": {lat:39.9526, lon:-75.1652},
            "Boise, ID": {lat:43.6150, lon:-116.2023},
            "Pittsburgh, PA": {lat:40.4406, lon:-79.9959},
            "Tucson, AZ": {lat:32.2226, lon:-110.9747},
            "Detroit, MI": {lat:42.3314, lon:-83.0458},
            "St. Petersburg, FL": {lat:27.7676, lon:-82.6403},
            "Oakland, CA": {lat:37.8044, lon:-122.2711},
            "San Jose, CA": {lat:37.3382, lon:-121.8863},
            "Cleveland, OH": {lat:41.4993, lon:-81.6944},
            "Raleigh, NC": {lat:35.7796, lon:-78.6382},
            "Phoenix, AZ": {lat:33.4484, lon:-112.0740},
            "Columbus, OH": {lat:39.9612, lon:-82.9988},
            "Los Angeles, CA": {lat:34.0522, lon:-118.2437},
            "Miami, FL": {lat:25.7617, lon:-80.1918},
            "New Orleans, LA": {lat:29.9511, lon:-90.0715},
            "Riverside, CA": {lat:33.9806, lon:-117.3755},
            "Tampa, FL": {lat:27.9506, lon:-82.4572},
            "Toledo, OH": {lat:41.6528, lon:-83.5379},
            "Cincinnati, OH": {lat:39.1031, lon:-84.5120},
            "Austin, TX": {lat:30.2672, lon:-97.7431},
            "Dallas, TX": {lat:32.7767, lon:-96.7970},
            "Atlanta, GA": {lat:33.7490, lon:-84.3880},
            "San Diego, CA": {lat:32.7157, lon:-117.1611},
            "Fort Worth, TX": {lat:32.7555, lon:-97.3308},
            "Durham, NC": {lat:35.9940, lon:-78.8986},
            "Charlotte, NC": {lat:35.2271, lon:-80.8431},

            // THE NEW AND MIDDLE CHUNK ADDITIONS
            "City of London, UK": {lat: 51.5128, lon: -0.0918},
            "Nijmegen, Netherlands": {lat: 51.8126, lon: 5.8372},
            "Tallinn, Estonia": {lat: 59.4370, lon: 24.7536},
            "Leuven, Belgium": {lat: 50.8798, lon: 4.7005},
            "Cambridge, MA": {lat: 42.3736, lon: -71.1097},
            "Minsk, Belarus": {lat: 53.9006, lon: 27.5590},
            "Somerville, MA": {lat: 42.3876, lon: -71.0995},
            "Innsbruck, Austria": {lat: 47.2692, lon: 11.4041},
            "Boulder, CO": {lat: 40.0150, lon: -105.2705},
            "Bolzano, Italy": {lat: 46.4983, lon: 11.3548},
            "Riga, Latvia": {lat: 56.9496, lon: 24.1052},
            "Tirana, Albania": {lat: 41.3275, lon: 19.8187},
            "Carmel, IN": {lat: 39.9784, lon: -86.1180},
            "Fort Collins, CO": {lat: 40.5853, lon: -105.0844},
            "Reykjavík, Iceland": {lat: 64.1466, lon: -21.9426},
            "Davis, CA": {lat: 38.5449, lon: -121.7405},
            "Palo Alto, CA": {lat: 37.4419, lon: -122.1430},
            "Dublin, Ireland": {lat: 53.3498, lon: -6.2603},
            "Budapest, Hungary": {lat: 47.4979, lon: 19.0402},
            "West Des Moines, IA": {lat: 41.5772, lon: -93.7113},
            "Vilnius, Lithuania": {lat: 54.6872, lon: 25.2797},
            "Santa Monica, CA": {lat: 34.0195, lon: -118.4912},
            "Iowa City, IA": {lat: 41.6611, lon: -91.5302},
            "Grandview Heights, OH": {lat: 39.9806, lon: -83.0402},
            "Ann Arbor, MI": {lat: 42.2808, lon: -83.7430},
            "Berkeley, CA": {lat: 37.8715, lon: -122.2730},
            "Ankeny, IA": {lat: 41.7303, lon: -93.5999},
            "Hoboken, NJ": {lat: 40.7440, lon: -74.0324},
            "Mackinac Island, MI": {lat: 45.8492, lon: -84.6186},
            "Corvallis, OR": {lat: 44.5646, lon: -123.2620},
            "Eugene, OR": {lat: 44.0521, lon: -123.0868},
            "Ohio City (Cleveland), OH": {lat: 41.4842, lon: -81.7062},
            "East Lansing, MI": {lat: 42.7369, lon: -84.4838},
            "Burlington, VT": {lat: 44.4759, lon: -73.2121},
            "Tegucigalpa, Honduras": {lat: 14.0818, lon: -87.2068},
            "Fargo, ND": {lat: 46.8772, lon: -96.7898},
            "Jackson, WY": {lat: 43.4799, lon: -110.7624},
            "Ames, IA": {lat: 42.0308, lon: -93.6319},
            "Bentonville, AR": {lat: 36.3729, lon: -94.2088},
            "Bloomington, IN": {lat: 39.1653, lon: -86.5264},
            "Westerville, OH": {lat: 40.1245, lon: -82.9210},
            "Lawrence, KS": {lat: 38.9717, lon: -95.2353},
            "Dublin, OH": {lat: 40.0992, lon: -83.1141},
            "Columbia, MD": {lat: 39.2037, lon: -76.8610},
            "Fayetteville, AR": {lat: 36.0822, lon: -94.1719},
            "Bexley, OH": {lat: 39.9689, lon: -82.9376},
            "The Woodlands, TX": {lat: 30.1658, lon: -95.4613},
            "Evanston, IL": {lat: 42.0451, lon: -87.6877},
            "Hilliard, OH": {lat: 40.0331, lon: -83.1585},
            "Shadyside (Pittsburgh), PA": {lat: 40.4532, lon: -79.9328},
            "Athens, OH": {lat: 39.3292, lon: -82.1013},
            "Cali, Colombia": {lat: 3.4516, lon: -76.5320},
            "Oberlin, OH": {lat: 41.2939, lon: -82.2174},
            "Xenia, OH": {lat: 39.6848, lon: -83.9296},
            "Grand Forks, ND": {lat: 47.9253, lon: -97.0329},
            "Provo, UT": {lat: 40.2338, lon: -111.6585},
            "Missoula, MT": {lat: 46.8721, lon: -113.9940},
            "Henderson, NV": {lat: 36.0395, lon: -114.9817},
            "Kent, OH": {lat: 41.1537, lon: -81.3579},
            "Andorra la Vella, Andorra": {lat: 42.5063, lon: 1.5218},
            "Ottawa Hills, OH": {lat: 41.6653, lon: -83.6380},
            "Kyiv, Ukraine": {lat: 50.4501, lon: 30.5234},
            "Mason, OH": {lat: 39.3601, lon: -84.3099},
            "Kathmandu, Nepal": {lat: 27.7172, lon: 85.3240},
            "Skopje, North Macedonia": {lat: 42.0006, lon: 21.4328},
            "Santa Barbara, CA": {lat: 34.4208, lon: -119.6982},
            "Bozeman, MT": {lat: 45.6770, lon: -111.0429},
            "Guayaquil, Ecuador": {lat: -2.1894, lon: -79.8891},
            "Worthington, OH": {lat: 40.0931, lon: -83.0180},
            "Chapel Hill, NC": {lat: 35.9132, lon: -79.0558},
            "Oxford, OH": {lat: 39.5070, lon: -84.7452},
            "Hyde Park (Cincinnati), OH": {lat: 39.1398, lon: -84.4444},
            "Cleveland Heights, OH": {lat: 41.5101, lon: -81.5612},
            "Las Vegas, NV": {lat: 36.1699, lon: -115.1398},
            "Lakewood, OH": {lat: 41.4819, lon: -81.7981},
            "Asuncion, Paraguay": {lat: -25.2637, lon: -57.5759},
            "Pristina, Kosovo": {lat: 42.6629, lon: 21.1655},
            "Oxford, MS": {lat: 34.3665, lon: -89.5192},
            "Wilmette, IL": {lat: 42.0767, lon: -87.7226},
            "Carroll, IA": {lat: 42.0653, lon: -94.8672},
            "Sao Paulo, Brazil": {lat: -23.5505, lon: -46.6333},
            "Dayton, OH": {lat: 39.7589, lon: -84.1916},
            "Sydney, NSW": {lat: -33.8688, lon: 151.2093},
            "Caracas, Venezuela": {lat: 10.4806, lon: -66.9036},
            "Greenville, SC": {lat: 34.8526, lon: -82.3940},
            "Pierre, SD": {lat: 44.3683, lon: -100.3510},
            "Jerusalem, Israel": {lat: 31.7683, lon: 35.2137},
            "Shaker Heights, OH": {lat: 41.4740, lon: -81.5372},
            "Maumee, OH": {lat: 41.5623, lon: -83.6535},
            "Newark, OH": {lat: 40.0581, lon: -82.4013},
            "Tehran, Iran": {lat: 35.6892, lon: 51.3890},
            "Doha, Qatar": {lat: 25.2854, lon: 51.5310},
            "Managua, Nicaragua": {lat: 12.1150, lon: -86.2362},
            "Rapid City, SD": {lat: 44.0805, lon: -103.2310},
            "Springfield, OH": {lat: 39.9242, lon: -83.8088},
            "Lima, Peru": {lat: -12.0464, lon: -77.0428},
            "Zagreb, Croatia": {lat: 45.8150, lon: 15.9819},
            "Portland, ME": {lat: 43.6591, lon: -70.2568},
            "Colombo, Sri Lanka": {lat: 6.9271, lon: 79.8612},
            "San Jose, Costa Rica": {lat: 9.9281, lon: -84.0907},
            "Akron, OH": {lat: 41.0814, lon: -81.5190},
            "Moscow, Russia": {lat: 55.7558, lon: 37.6173},
            "Podgorica, Montenegro": {lat: 42.4411, lon: 19.2636},
            "Troy, OH": {lat: 40.0395, lon: -84.2044},
            "Brisbane, QLD": {lat: -27.4705, lon: 153.0260},
            "Sarajevo, Bosnia and Herzegovina": {lat: 43.8563, lon: 18.4131},
            "Madison, AL": {lat: 34.6993, lon: -86.7483},
            "Perrysburg, OH": {lat: 41.5534, lon: -83.6273},
            "Bowling Green, OH": {lat: 41.3748, lon: -83.6513},
            "Upper Arlington, OH": {lat: 40.0073, lon: -83.0535},
            "Stow, OH": {lat: 41.1595, lon: -81.4404},
            "Saint Petersburg, Russia": {lat: 59.9311, lon: 30.3609},
            "Bamako, Mali": {lat: 12.6392, lon: -8.0029},
            "Niamey, Niger": {lat: 13.5116, lon: 2.1254},
            "Canton, OH": {lat: 40.7989, lon: -81.3784},
            "Sewickley, PA": {lat: 40.5401, lon: -80.1820},
            "Rio de Janeiro, Brazil": {lat: -22.9068, lon: -43.1729},
            "Kansas City, MO": {lat: 39.0997, lon: -94.5786},
            "Lorain, OH": {lat: 41.4528, lon: -82.1824},
            "Indianapolis, IN": {lat: 39.7684, lon: -86.1581},
            "Sedona, AZ": {lat: 34.8697, lon: -111.7610},
            "Casablanca, Morocco": {lat: 33.5731, lon: -7.5898},
            "Kettering, OH": {lat: 39.6895, lon: -84.1688},
            "San Antonio, TX": {lat: 29.4241, lon: -98.4936},
            "Bay Village, OH": {lat: 41.4839, lon: -81.9213},
            "Sana’a, Yemen": {lat: 15.3694, lon: 44.1910},
            "Ouagadougou, Burkina Faso": {lat: 12.3714, lon: -1.5197},
            "Cuyahoga Falls, OH": {lat: 41.1339, lon: -81.4846},
            "Rocky River, OH": {lat: 41.4745, lon: -81.8385},
            "Baghdad, Iraq": {lat: 33.3152, lon: 44.3661},
            "Middletown, OH": {lat: 39.5151, lon: -84.3983},
            "Sandusky, OH": {lat: 41.4489, lon: -82.7080},
            "Auckland, New Zealand": {lat: -36.8485, lon: 174.7633},
            "Khartoum, Sudan": {lat: 15.5007, lon: 32.5599},
            "Guatemala City, Guatemala": {lat: 14.6349, lon: -90.5069},
            "Parma, OH": {lat: 41.4048, lon: -81.7226},
            "Nouakchott, Mauritania": {lat: 18.0790, lon: -15.9652},
            "Youngstown, OH": {lat: 41.0998, lon: -80.6495},
            "Havana, Cuba": {lat: 23.1136, lon: -82.3666},
            "Hudson, OH": {lat: 41.2401, lon: -81.4407},
            "Elyria, OH": {lat: 41.3684, lon: -82.1076},
            "Yaounde, Cameroon": {lat: 3.8480, lon: 11.5021},
            "Lubumbashi, Democratic Republic of the Congo": {lat: -11.6609, lon: 27.4794},
            "Dhaka, Bangladesh": {lat: 23.8103, lon: 90.4125},
            "Riyadh, Saudi Arabia": {lat: 24.7136, lon: 46.6753},
            "Maputo, Mozambique": {lat: -25.9692, lon: 32.5732},
            "Tallmadge, OH": {lat: 41.1014, lon: -81.4419},
            "Istanbul, Turkey": {lat: 41.0082, lon: 28.9784},
            "Astana, Kazakhstan": {lat: 51.1694, lon: 71.4491},
            "Algiers, Algeria": {lat: 36.7538, lon: 3.0588},
            "Ulaanbaatar, Mongolia": {lat: 47.9200, lon: 106.9170},
            "Chandigarh, India": {lat: 30.7333, lon: 76.7794},
            "Westlake, OH": {lat: 41.4550, lon: -81.9182},
            "Abu Dhabi, United Arab Emirates": {lat: 24.4539, lon: 54.3773},
            "Hamilton, OH": {lat: 39.3995, lon: -84.5613},
            "N’Djamena, Chad": {lat: 12.1348, lon: 15.0557},
            "Karachi, Pakistan": {lat: 24.8607, lon: 67.0011},
            "Brazzaville, Republic of the Congo": {lat: -4.2634, lon: 15.2429},
            "Harare, Zimbabwe": {lat: -17.8216, lon: 31.0492},
            "Nashville, TN": {lat: 36.1627, lon: -86.7816},
            "Dodoma City, Tanzania": {lat: -6.1630, lon: 35.7516},
            "Gaborone, Botswana": {lat: -24.6282, lon: 25.9231},
            "Phnom Penh, Cambodia": {lat: 11.5564, lon: 104.9282},
            "Bowling Green, KY": {lat: 36.9903, lon: -86.4436},
            "Dubai, United Arab Emirates": {lat: 25.2048, lon: 55.2708},
            "Muscat, Oman": {lat: 23.5859, lon: 58.4059},
            "Tripoli, Libya": {lat: 32.8872, lon: 13.1913},
            "Bangui, Central African Republic": {lat: 4.3947, lon: 18.5582},
            "San Luis Obispo, CA": {lat: 35.2828, lon: -120.6596},
            "Cairo, Egypt": {lat: 30.0444, lon: 31.2357},
            "Kinshasa, Democratic Republic of the Congo": {lat: -4.4419, lon: 15.2663},
            "Lagos, Nigeria": {lat: 6.5244, lon: 3.3792},
            "Green, OH": {lat: 40.9439, lon: -81.4754},
            "Broadview Heights, OH": {lat: 41.3284, lon: -81.6846},
            "Kabul, Afghanistan": {lat: 34.5553, lon: 69.2075},
            "Brimfield Township, OH": {lat: 41.0851, lon: -81.3323},
            "Tashkent, Uzbekistan": {lat: 41.2995, lon: 69.2401},
            "Santa Cruz de la Sierra, Bolivia": {lat: -17.7833, lon: -63.1821},
            "Accra, Ghana": {lat: 5.6037, lon: -0.1870},
            "Kampala, Uganda": {lat: 0.3476, lon: 32.5825},
            "Conakry, Guinea": {lat: 9.5092, lon: -13.7122},
            "Lome, Togo": {lat: 6.1375, lon: 1.2125},
            "Dakar, Senegal": {lat: 14.7167, lon: -17.4677},
            "Oklahoma City, OK": {lat: 35.4676, lon: -97.5164},
            "Enid, OK": {lat: 36.3956, lon: -97.8784},
            "Norman, OK": {lat: 35.2226, lon: -97.4395},
            "Lyon, France": {lat: 45.7640, lon: 4.8357},
            "Marseille, France": {lat: 43.2965, lon: 5.3698},
            "Sacramento, CA": {lat: 38.5816, lon: -121.4944},
            "Huntington, WV": {lat: 38.4192, lon: -82.4452},
            "Nay Pyi Taw, Myanmar": {lat: 19.7633, lon: 96.0785},
            "Overland Park, KS": {lat: 38.9822, lon: -94.6708},
            "Jakarta, Indonesia": {lat: -6.2088, lon: 106.8456},
            "New Haven, CT": {lat: 41.3083, lon: -72.9279},
            "Manchester, NH": {lat: 42.9956, lon: -71.4548},
            "Hartford, CT": {lat: 41.7658, lon: -72.6734},
            "Las Cruces, NM": {lat: 32.3199, lon: -106.7637},
            "Chisinau, Moldova": {lat: 47.0105, lon: 28.8638},
            "Karakol, Kyrgyzstan": {lat: 42.4907, lon: 78.3936},
            "Abidjan, Ivory Coast": {lat: 5.3599, lon: -4.0083},
            "Amman, Jordan": {lat: 31.9454, lon: 35.9284},
            "Juba, South Sudan": {lat: 4.8594, lon: 31.5713},
            "Turin, Italy": {lat: 45.0703, lon: 7.6869},
            "Lexington, KY": {lat: 38.0406, lon: -84.5037},
            "Providence, RI": {lat: 41.8240, lon: -71.4128},
            "Honolulu, HI": {lat: 21.3069, lon: -157.8583},
            "Cheyenne, WY": {lat: 41.1400, lon: -104.8202},
            "Tempe, AZ": {lat: 33.4255, lon: -111.9400},
            "Baton Rouge, LA": {lat: 30.4515, lon: -91.1871},
            "Savannah, GA": {lat: 32.0809, lon: -81.0912},
            "San Juan, Puerto Rico": {lat: 18.4655, lon: -66.1057},
            "Rio Rancho, NM": {lat: 35.2328, lon: -106.6630},
            "Casper, WY": {lat: 42.8666, lon: -106.3131},
            "Huntsville, AL": {lat: 34.7304, lon: -86.5861},
            "Yangon, Myanmar": {lat: 16.8409, lon: 96.1495},
            "Pyongyang, North Korea": {lat: 39.0392, lon: 125.7625},
            "Melbourne, VIC": {lat: -37.8136, lon: 144.9631},
            "San Salvador, El Salvador": {lat: 13.6929, lon: -89.2182},
            "Luanda, Angola": {lat: -8.8390, lon: 13.2894},
            "Aleppo, Syria": {lat: 36.2021, lon: 37.1343},
            "Almaty, Kazakhstan": {lat: 43.2220, lon: 76.8512},
            "Alexandria, VA": {lat: 38.8048, lon: -77.0469},
            "Champaign, IL": {lat: 40.1164, lon: -88.2434},
            "Jersey City, NJ": {lat: 40.7282, lon: -74.0776},
            "Sioux Falls, SD": {lat: 43.5473, lon: -96.7283},
            "Houston, TX": {lat: 29.7604, lon: -95.3698},
            "Orlando, FL": {lat: 28.5383, lon: -81.3792},
            "Columbia, SC": {lat: 34.0007, lon: -81.0348},
            "Aurora, CO": {lat: 39.7294, lon: -104.8319},
            "Gainesville, FL": {lat: 29.6516, lon: -82.3248},
            "Sarasota, FL": {lat: 27.3364, lon: -82.5307},
            "Wichita, KS": {lat: 37.6872, lon: -97.3301},
            "Louisville, KY": {lat: 38.2527, lon: -85.7585},
            "El Paso, TX": {lat: 31.7619, lon: -106.4850},
            "Miami Beach, FL": {lat: 25.7907, lon: -80.1300},
            "Key West, FL": {lat: 24.5551, lon: -81.7800},
            "Macau, China": {lat: 22.1987, lon: 113.5439},
            "Kunshan, China": {lat: 31.3853, lon: 120.9807},
            "Yiwu, China": {lat: 29.3069, lon: 120.0753},
            "David, Panama": {lat: 8.4270, lon: -82.4312},
            "Vientiane, Laos": {lat: 17.9757, lon: 102.6331},
            "George Town, Malaysia": {lat: 5.4141, lon: 100.3288},
            "Sousse, Tunisia": {lat: 35.8256, lon: 10.6366},
            "Victoria, BC": {lat: 48.4284, lon: -123.3656},
            "Siem Reap, Cambodia": {lat: 13.3611, lon: 103.8564},
            "Hoi An, Vietnam": {lat: 15.8801, lon: 108.3380},
            "Isfahan, Iran": {lat: 32.6539, lon: 51.6660},
            "Saskatoon, SK": {lat: 52.1332, lon: -106.6700},
            "Winnipeg, MB": {lat: 49.8951, lon: -97.1384},
			"Perth, WA (AU)": {lat: -31.9505, lon: 115.8605},
            "Perth, WA(AU)": {lat: -31.9505, lon: 115.8605},
            "Yerevan, Armenia": {lat: 40.1872, lon: 44.5152},
            "Dushanbe, Tajikistan": {lat: 38.5598, lon: 68.7870},
            "Libreville, Gabon": {lat: 0.4162, lon: 9.4673},
            "Ashgabat, Turkmenistan": {lat: 37.9601, lon: 58.3261},
            "Hargeisa, Somaliland": {lat: 9.5600, lon: 44.0650},
            "Baku, Azerbaijan": {lat: 40.4093, lon: 49.8671},
            "Georgetown, Guyana": {lat: 6.8013, lon: -58.1551},
            "Paramaribo, Suriname": {lat: 5.8520, lon: -55.2038},
            "Sohar, Oman": {lat: 24.3461, lon: 56.7075},
            "Linden, Guyana": {lat: 5.9960, lon: -58.2995},
            "Lelydorp, Suriname": {lat: 5.6969, lon: -55.2215},
            "Baidoa, Somalia": {lat: 3.1138, lon: 43.6503},
            "Thimphu, Bhutan": {lat: 27.4728, lon: 89.6393},
            "Turkmenabat, Turkmenistan": {lat: 39.0828, lon: 63.5670},
            "Aalborg, Denmark": {lat: 57.0488, lon: 9.9217},
            "Aarhus, Denmark": {lat: 56.1496, lon: 10.2040},
            "Odense, Denmark": {lat: 55.3959, lon: 10.3883},
            "Bergen, Norway": {lat: 60.3913, lon: 5.3221},
            "Bern, Switzerland": {lat: 46.9480, lon: 7.4474},
            "Beirut, Lebanon": {lat: 33.8938, lon: 35.5018},
            "Santo Domingo, Dominican Republic": {lat: 18.4861, lon: -69.9312},
            "Koto, Japan": {lat: 35.6728, lon: 139.8174},
            "Gdansk, Poland": {lat: 54.3520, lon: 18.6466},
            "Emfuleni, South Africa": {lat: -26.6853, lon: 27.8542},
            "Johannesburg, South Africa": {lat: -26.2041, lon: 28.0473},
            "Xiamen, China": {lat: 24.4798, lon: 118.0894},
            "Lusaka, Zambia": {lat: -15.3875, lon: 28.3228},
            "Cotonou, Benin": {lat: 6.3654, lon: 2.4183},
            "Ferrara, Italy": {lat: 44.8381, lon: 11.6198},
            "Winterthur, Switzerland": {lat: 47.4984, lon: 8.7241},
            "Salzburg, Austria": {lat: 47.8095, lon: 13.0550},
            "Lund, Sweden": {lat: 55.7047, lon: 13.1910},
            "Oldenburg, Germany": {lat: 53.1435, lon: 8.2146},
            "Belize City, Belize": {lat: 17.5046, lon: -88.1962},
            "Tartus, Syria": {lat: 34.8890, lon: 35.8866},
            "Damascus, Syria": {lat: 33.5138, lon: 36.2765},
            "Lae, Papua New Guinea": {lat: -6.7260, lon: 146.9912},
            "Iloilo City, Philippines": {lat: 10.7202, lon: 122.5621},
            "Merida, Mexico": {lat: 20.9674, lon: -89.5926},
            "Mérida, Mexico": {lat: 20.9674, lon: -89.5926},
            "Cambridge, UK": {lat: 52.2053, lon: 0.1218},
            "Hackney, UK": {lat: 51.5450, lon: -0.0553},
            "Islington, UK": {lat: 51.5416, lon: -0.1022},
            "Newham, UK": {lat: 51.5077, lon: 0.0469},
            "Waltham Forest, UK": {lat: 51.5908, lon: -0.0134},
            "Oxford, UK": {lat: 51.7520, lon: -1.2577},
            "Ashland, OR": {lat: 42.1946, lon: -122.7095},
            "Cardiff, UK": {lat: 51.4816, lon: -3.1791},
            "Aurora, IL": {lat: 41.7606, lon: -88.3201},
            "Oaxaca, Mexico": {lat: 17.0732, lon: -96.7266},
            "Alicante, Spain": {lat: 38.3460, lon: -0.4907},
            "Gatineau, QC": {lat: 45.4287, lon: -75.7124},
            "La Crosse, WI": {lat: 43.8014, lon: -91.2396},
            "Queens, NY": {lat: 40.7282, lon: -73.7949},
            "Christchurch, New Zealand": {lat: -43.5321, lon: 172.6362},
            "Portsmouth, OH": {lat: 38.7317, lon: -82.9977},
            "Glasgow, UK": {lat: 55.8642, lon: -4.2518},
            "Zapopan, Mexico": {lat: 20.7220, lon: -103.3918},
            "Aberdeen, SD": {lat: 45.4647, lon: -98.4865},
            "Monterrey, Mexico": {lat: 25.6866, lon: -100.3161},
            "Chico, CA": {lat: 39.7285, lon: -121.8375},
            "Porto Alegre, Brazil": {lat: -30.0346, lon: -51.2177},
            "Longmont, CO": {lat: 40.1672, lon: -105.1019},
            "Plainfield, NJ": {lat: 40.6184, lon: -74.4171},
            "Genoa, Italy": {lat: 44.4056, lon: 8.9463},
            "Alameda, CA": {lat: 37.7652, lon: -122.2416},
            "Woodland, CA": {lat: 38.6785, lon: -121.7733},
            "Maple Grove, MN": {lat: 45.0725, lon: -93.4558},
            "Eau Claire, WI": {lat: 44.8113, lon: -91.4985},
            "Logan, UT": {lat: 41.7310, lon: -111.8349},
            "Staten Island, NY": {lat: 40.5795, lon: -74.1502},
            "Woodbury, MN": {lat: 44.9239, lon: -92.4626},
            "Broomfield, CO": {lat: 39.9205, lon: -105.0861},
            "Bellingham, WA": {lat: 48.7519, lon: -122.4787},
            "Tampere, Finland": {lat: 61.4978, lon: 23.7610},
            "Graz, Austria": {lat: 47.0707, lon: 15.4395},
            "Poznań, Poland": {lat: 52.4064, lon: 16.9252},
            "Zaragoza, Spain": {lat: 41.6497, lon: -0.8877},
            "Bristol, UK": {lat: 51.4545, lon: -2.5879},
            "Wilmington, DE": {lat: 39.7391, lon: -75.5398},
            "Avon Lake, OH": {lat: 41.5037, lon: -82.0221},
            "Albuquerque, NM": {lat: 35.0844, lon: -106.6504},
            "Oak Park, IL": {lat: 41.8850, lon: -87.7845},
            "Willoughby, OH": {lat: 41.6398, lon: -81.4065},
            "Mentor, OH": {lat: 41.6662, lon: -81.3396},
            "Barberton, OH": {lat: 41.0123, lon: -81.6051},
            "North Canton, OH": {lat: 40.8759, lon: -81.4026},
            "Newark, NJ": {lat: 40.7357, lon: -74.1724},
            "North Olmsted, OH": {lat: 41.4150, lon: -81.9221},
            "Jacksonville, FL": {lat: 30.3322, lon: -81.6557},
            "Naperville, IL": {lat: 41.7508, lon: -88.1535},
            "Brno, Czechia": {lat: 49.1951, lon: 16.6068},
            "Galway, Ireland": {lat: 53.2707, lon: -9.0568},
            "Kaunas, Lithuania": {lat: 54.8985, lon: 23.9036},
            "Liepaja, Latvia": {lat: 56.5047, lon: 21.0108},
            "Limassol, Cyprus": {lat: 34.6748, lon: 33.0385},
            "Maribor, Slovenia": {lat: 46.5547, lon: 15.6459},
            "Thessaloniki, Greece": {lat: 40.6401, lon: 22.9444},
			// --- THE FINAL MISSING CHUNK ---
            "Hargeisa, Somaliland": {lat: 9.5600, lon: 44.0650},
            "Kunshan, China": {lat: 31.3853, lon: 120.9807},
            "Baidoa, Somalia": {lat: 3.1138, lon: 43.6503},
            "Yiwu, China": {lat: 29.3069, lon: 120.0753},
            "Aleppo, Syria": {lat: 36.2021, lon: 37.1343},
            "Sohar, Oman": {lat: 24.3461, lon: 56.7075},
            "Xiamen, China": {lat: 24.4798, lon: 118.0894},
            "Pyongyang, North Korea": {lat: 39.0392, lon: 125.7625},
            "Amman, Jordan": {lat: 31.9454, lon: 35.9284},
            "Tartus Subdistrict, Syria": {lat: 34.8890, lon: 35.8866},
            "Emfuleni Local Municipality, South Africa": {lat: -26.6853, lon: 27.8542},
            "Yangon, Myanmar": {lat: 16.8409, lon: 96.1495},
            "Libreville, Gabon": {lat: 0.4162, lon: 9.4673},
            "Juba, South Sudan": {lat: 4.8594, lon: 31.5713},
            "Lelydorp, Suriname": {lat: 5.6969, lon: -55.2215},
            "Linden, Guyana": {lat: 5.9960, lon: -58.2995},
            "Vientiane, Laos": {lat: 17.9757, lon: 102.6331},
            "Siem Reap, Cambodia": {lat: 13.3611, lon: 103.8564},
            "Huntsville, AL": {lat: 34.7304, lon: -86.5861},
            "Turkmenabat, Turkmenistan": {lat: 39.0828, lon: 63.5670},
            "Lae District, Papua New Guinea": {lat: -6.7260, lon: 146.9912},
            "City of Johannesburg Metropolitan Municipality, South Africa": {lat: -26.2041, lon: 28.0473},
            "Ashgabat, Turkmenistan": {lat: 37.9601, lon: 58.3261},
            "Santo Domingo, Dominican Republic": {lat: 18.4861, lon: -69.9312},
            "Lusaka District, Zambia": {lat: -15.3875, lon: 28.3228},
            "Savannah, GA": {lat: 32.0809, lon: -81.0912},
            "Abidjan, Ivory Coast": {lat: 5.3599, lon: -4.0083},
            "Louisville, KY": {lat: 38.2527, lon: -85.7585},
            "El Paso, TX": {lat: 31.7619, lon: -106.4850},
            "Baku, Azerbaijan": {lat: 40.4093, lon: 49.8671},
            "Chattanooga, TN": {lat: 35.0456, lon: -85.3097},
            "Columbia, SC": {lat: 34.0007, lon: -81.0348},
            "Rio Rancho, NM": {lat: 35.2328, lon: -106.6630},
            "Lexington, KY": {lat: 38.0406, lon: -84.5037},
            "Baton Rouge, LA": {lat: 30.4515, lon: -91.1871},
            "Damascus Governorate, Syria": {lat: 33.5138, lon: 36.2765},
            "George Town, Malaysia": {lat: 5.4141, lon: 100.3288},
            "Cotonou, Benin": {lat: 6.3654, lon: 2.4183},
            "Macau, China": {lat: 22.1987, lon: 113.5439},
            "Aalborg Municipality, Denmark": {lat: 57.0488, lon: 9.9217},
            "Honolulu, HI": {lat: 21.3069, lon: -157.8583},
            "Luanda, Angola": {lat: -8.8390, lon: 13.2894},
            "San Juan, Puerto Rico": {lat: 18.4655, lon: -66.1057},
            "Yerevan, Armenia": {lat: 40.1872, lon: 44.5152},
            "Houston, TX": {lat: 29.7604, lon: -95.3698},
            "Georgetown, Guyana": {lat: 6.8013, lon: -58.1551},
            "Sousse, Tunisia": {lat: 35.8256, lon: 10.6366},
            "Ferrara, Italy": {lat: 44.8381, lon: 11.6198},
            "Thimphu, Bhutan": {lat: 27.4728, lon: 89.6393},
            "Almaty, Kazakhstan": {lat: 43.2220, lon: 76.8512},
            "Dushanbe, Tajikistan": {lat: 38.5598, lon: 68.7870},
            "Casper, WY": {lat: 42.8666, lon: -106.3131},
            "Wichita, KS": {lat: 37.6872, lon: -97.3301},
            "Turin, Italy": {lat: 45.0703, lon: 7.6869},
            "Belize City, Belize": {lat: 17.5046, lon: -88.1962},
            "Sarasota, FL": {lat: 27.3364, lon: -82.5307},
            "Isfahan, Iran": {lat: 32.6539, lon: 51.6660},
            "San Salvador, El Salvador": {lat: 13.6929, lon: -89.2182},
            "Sioux Falls, SD": {lat: 43.5473, lon: -96.7283},
            "Orlando, FL": {lat: 28.5383, lon: -81.3792},
            "Champaign, IL": {lat: 40.1164, lon: -88.2434},
            "Gainesville, FL": {lat: 29.6516, lon: -82.3248},
            "Beirut, Lebanon": {lat: 33.8938, lon: 35.5018},
            "David, Panama": {lat: 8.4270, lon: -82.4312},
            "Hoi An, Vietnam": {lat: 15.8801, lon: 108.3380},
            "Paramaribo, Suriname": {lat: 5.8520, lon: -55.2038},
            "Providence, RI": {lat: 41.8240, lon: -71.4128},
            "Jersey City, NJ": {lat: 40.7282, lon: -74.0776},
            "Bellingham, WA": {lat: 48.7519, lon: -122.4787},
            "Aurora, CO": {lat: 39.7294, lon: -104.8319},
            "Koto, Tokyo": {lat: 35.6728, lon: 139.8174},
            "Melbourne, VIC": {lat: -37.8136, lon: 144.9631},
            "Cheyenne, WY": {lat: 41.1400, lon: -104.8202},
            "Key West, FL": {lat: 24.5551, lon: -81.7800},
            "Winnipeg, MB": {lat: 49.8951, lon: -97.1384},
            "Bergen, Norway": {lat: 60.3913, lon: 5.3221},
            "Colorado Springs, CO": {lat: 38.8339, lon: -104.8214},
            "Aarhus Municipality, Denmark": {lat: 56.1496, lon: 10.2040},
            "Tempe, AZ": {lat: 33.4255, lon: -111.9400},
            "Miami Beach, FL": {lat: 25.7907, lon: -80.1300},
            "Odense Municipality, Denmark": {lat: 55.3959, lon: 10.3883},
            "Coeur d'Alene, ID": {lat: 47.6732, lon: -116.7812},
            "Saskatoon, SK": {lat: 52.1332, lon: -106.6700},
            "Victoria, BC": {lat: 48.4284, lon: -123.3656},
            "Alexandria, VA": {lat: 38.8048, lon: -77.0469},
            "Woodbury, MN": {lat: 44.9239, lon: -92.4626},
            "Bern, Switzerland": {lat: 46.9480, lon: 7.4474},
            "Winterthur, Switzerland": {lat: 47.4984, lon: 8.7241},
            "Salzburg, Austria": {lat: 47.8095, lon: 13.0550},
            "Canberra [Australian Capital Territory], ACT": {lat: -35.2809, lon: 149.1300},
            "Gdansk, Poland": {lat: 54.3520, lon: 18.6466},
            "Lund, Sweden": {lat: 55.7047, lon: 13.1910},
            "Oldenburg, Germany": {lat: 53.1435, lon: 8.2146},
            "Munster, Germany": {lat: 51.9607, lon: 7.6261},
            "Hackney, UK": {lat: 51.5450, lon: -0.0553},
            "Paris, France": {lat: 48.8566, lon: 2.3522},
            "Astana  [Nur-Sultan], Kazakhstan": {lat: 51.1694, lon: 71.4491},
			"Grenoble, France": {lat: 45.1885, lon: 5.7245},
			"Liverpool, UK": {lat: 53.4084, lon: -2.9916},
			"Hobart, Tasmania": {lat: -42.8821, lon: 147.3272},
			"Ho Chi Minh City, Vietnam": {lat: 10.8231, lon: 106.6297},
			"Dar es Salaam, Tanzania": {lat: -6.7924, lon: 39.2083},
			"Kano, Nigeria": {lat: 12.0022, lon: 8.5920},
			"Belo Horizonte, Brazil": {lat: -19.9167, lon: -43.9345},
			"Virginia Beach, VA": {lat: 36.8529, lon: -75.9780},
			"Richmond, VA": {lat: 37.5407, lon: -77.4360},
			"Memphis, TN": {lat: 35.1495, lon: -90.0490},
			"Buffalo, NY": {lat: 42.8864, lon: -78.8784}
					};

        // --- GLOBAL STATE ---
        let rawData = [];
        let currentMapScale = 1; // CHANGED: Tracks zoom level for point scaling
		let zoomTimeout = null; // NEW: For smoothing out the zoom limit
        let currentFocus = 'Balanced';
        let currentLabelMode = 'None'; 
        let currentView = 'graph'; 
        let currentIndivStat = 'Safe Area (sq mi)'; 
        let statReverse = false; 
        let neighborDispReverse = false; 
        let focusDispReverse = false; 
        let pfbReverse = true; 
        let copenhagenReverse = true; 

        document.getElementById('csvFile').addEventListener('change', handleFileUpload);
        document.getElementById('graphTitle').addEventListener('input', updateView);
        document.getElementById('sizeSlider').addEventListener('input', updateView);
        document.getElementById('forceCircle').addEventListener('change', updateView);

        function handlePopChange(el) {
            let val = parseFloat(el.value);
            if (isNaN(val)) val = 0;
            if (val > 10000000) { val = 10000000; el.value = val; }
            if (val < 0) { val = 0; el.value = val; }
            if (val < 20000) el.step = 1000;
            else if (val < 200000) el.step = 10000;
            else el.step = 100000;
            updateView();
        }

        function cycleView() {
            const btn = document.getElementById('viewToggleBtn');
            const graphOpts = document.getElementById('graph-options');
            const mapControl = document.getElementById('map-control');
            const aggControl = document.getElementById('agg-control');
            const chartC = document.getElementById('chart-container');
            const mapC = document.getElementById('map-container');
            const listC = document.getElementById('list-view-container');

            if (currentView === 'graph') {
                currentView = 'map';
                btn.textContent = "Switch to List View";
                graphOpts.classList.add('hidden');
                chartC.classList.add('hidden');
                mapC.style.display = 'block';
                listC.style.display = 'none';
                mapControl.classList.remove('hidden');
                aggControl.classList.remove('hidden'); // Map uses aggregation now
            } else if (currentView === 'map') {
                currentView = 'list';
                btn.textContent = "Switch to Graph View";
                graphOpts.classList.add('hidden');
                chartC.classList.add('hidden');
                mapC.style.display = 'none';
                listC.style.display = 'block';
                mapControl.classList.add('hidden');
                aggControl.classList.remove('hidden');
            } else {
                currentView = 'graph';
                btn.textContent = "Switch to Map View";
                graphOpts.classList.remove('hidden');
                chartC.classList.remove('hidden');
                mapC.style.display = 'none';
                listC.style.display = 'none';
                mapControl.classList.add('hidden');
                aggControl.classList.add('hidden');
            }
            updateView();
        }

        function setFocus(focusType) {
            currentFocus = focusType;
            const buttons = document.querySelectorAll('#focusButtons button');
            buttons.forEach(btn => {
                const text = btn.textContent;
                btn.classList.remove('active', 'active-infra', 'active-balanced', 'active-dest');
                if (text === focusType) {
                    if (text === 'Infrastructure') btn.classList.add('active-infra');
                    else if (text === 'Balanced') btn.classList.add('active-balanced');
                    else btn.classList.add('active-dest');
                }
            });
            updateView();
        }

        function setLabelMode(mode) {
            currentLabelMode = mode;
            document.querySelectorAll('#labelButtons button').forEach(btn => {
                const isActive = (btn.textContent === 'None' && mode === 'None') || btn.textContent.includes(mode);
                btn.classList.toggle('active', isActive);
            });
            updateView();
        }

        function downloadChart() {
            if (currentView === 'graph') {
                Plotly.downloadImage('chart-container', { format: 'png', width: 1920, height: 960, filename: 'bike_safety_chart' });
            } else if (currentView === 'map') {
                Plotly.downloadImage('map-container', { format: 'png', width: 1920, height: 960, filename: 'bike_safety_map' });
            } else {
                alert("Switch to Graph or Map View to download.");
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    rawData = results.data;
                    updateView();
                    
                    // CHANGED: Wipes the file input memory after a successful upload. 
                    // This forces the browser to register a 'change' event even if you 
                    // upload a file with the exact same name a minute later.
                    event.target.value = ''; 
                }
            });
        }

        function updateStat(val) { currentIndivStat = val; updateList(); }
        function toggleStatSort() { statReverse = !statReverse; updateList(); }
        function toggleNeighborDisp(mode) { neighborDispReverse = (mode === 'smallest'); updateList(); }
        function toggleFocusDisp(mode) { focusDispReverse = (mode === 'dest'); updateList(); }
        function togglePFB(mode) { pfbReverse = (mode === 'overrated'); updateList(); }
        function toggleCopenhagen(mode) { copenhagenReverse = (mode === 'overrated'); updateList(); }

        // --- DATA HELPERS ---
        function formatLocation(name) {
            if (!name) return 'Unknown';
            const upper = name.trim().toUpperCase();
            const mapping = {
                'ALABAMA': 'AL', 'ALASKA': 'AK', 'ARIZONA': 'AZ', 'ARKANSAS': 'AR', 'CALIFORNIA': 'CA',
                'COLORADO': 'CO', 'CONNECTICUT': 'CT', 'DELAWARE': 'DE', 'FLORIDA': 'FL', //'GEORGIA': 'GA',
                'HAWAII': 'HI', 'IDAHO': 'ID', 'ILLINOIS': 'IL', 'INDIANA': 'IN', 'IOWA': 'IA',
                'KANSAS': 'KS', 'KENTUCKY': 'KY', 'LOUISIANA': 'LA', 'MAINE': 'ME', 'MARYLAND': 'MD',
                'MASSACHUSETTS': 'MA', 'MICHIGAN': 'MI', 'MINNESOTA': 'MN', 'MISSISSIPPI': 'MS', 'MISSOURI': 'MO',
                'MONTANA': 'MT', 'NEBRASKA': 'NE', 'NEVADA': 'NV', 'NEW HAMPSHIRE': 'NH', 'NEW JERSEY': 'NJ',
                'NEW MEXICO': 'NM', 'NEW YORK': 'NY', 'NORTH CAROLINA': 'NC', 'NORTH DAKOTA': 'ND', 'OHIO': 'OH',
                'OKLAHOMA': 'OK', 'OREGON': 'OR', 'PENNSYLVANIA': 'PA', 'RHODE ISLAND': 'RI', 'SOUTH CAROLINA': 'SC',
                'SOUTH DAKOTA': 'SD', 'TENNESSEE': 'TN', 'TEXAS': 'TX', 'UTAH': 'UT', 'VERMONT': 'VT',
                'VIRGINIA': 'VA', 'WASHINGTON': 'WA', 'WEST VIRGINIA': 'WV', 'WISCONSIN': 'WI', 'WYOMING': 'WY',
                'DISTRICT OF COLUMBIA': 'DC', 'ALBERTA': 'AB', 'BRITISH COLUMBIA': 'BC', 'MANITOBA': 'MB', 
                'NEW BRUNSWICK': 'NB', 'NEWFOUNDLAND AND LABRADOR': 'NL', 'NORTHWEST TERRITORIES': 'NT', 
                'NOVA SCOTIA': 'NS', 'NUNAVUT': 'NU', 'ONTARIO': 'ON', 'PRINCE EDWARD ISLAND': 'PE', 
                'QUEBEC': 'QC', 'SASKATCHEWAN': 'SK', 'YUKON': 'YT'
            };
            return mapping[upper] || name; 
        }

        function getRegion(locationStr) {
            if (!locationStr) return 'Other';
            const loc = locationStr.toString().toUpperCase().trim();
            const naCodes = [
                'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 
                'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 
                'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 
                'WI', 'WY', 'DC', 'USA', 'UNITED STATES', 'AB', 'BC', 'MB', 'NB', 'NS', 'NT', 'NU', 'ON', 'PE', 
                'QC', 'SK', 'YT', 'CAN', 'CANADA', 'MEXICO'
            ];
            const euroNames = [
                'ALBANIA', 'ANDORRA', 'ARMENIA', 'AUSTRIA', 'AZERBAIJAN', 'BELARUS', 'BELGIUM', 'BOSNIA', 
                'HERZEGOVINA', 'BULGARIA', 'CROATIA', 'CYPRUS', 'CZECHIA', 'CZECH REPUBLIC', 'DENMARK', 'ESTONIA', 
                'FINLAND', 'FRANCE', 'GEORGIA', 'GERMANY', 'GREECE', 'HUNGARY', 'ICELAND', 'IRELAND', 'ITALY', 
                'KAZAKHSTAN', 'KOSOVO', 'LATVIA', 'LIECHTENSTEIN', 'LITHUANIA', 'LUXEMBOURG', 'MALTA', 'MOLDOVA', 
                'MONACO', 'MONTENEGRO', 'NETHERLANDS', 'MACEDONIA', 'NORWAY', 'POLAND', 'PORTUGAL', 'ROMANIA', 
                'RUSSIA', 'SAN MARINO', 'SERBIA', 'SLOVAKIA', 'SLOVENIA', 'SPAIN', 'SWEDEN', 'SWITZERLAND', 
                'TURKEY', 'UKRAINE', 'UNITED KINGDOM', 'UK', 'GB', 'VATICAN'
            ];
            // CHANGED: Instead of using .includes() which catches partial string matches, 
			// we now split the location string by commas and spaces. We then check if the 
			// exact code exists as a standalone word in that resulting array.
			const locWords = loc.split(/[\s,]+/);
			const isCodeMatch = (list) => list.some(c => locWords.includes(c));
			
			const isNameMatch = (list) => list.some(n => loc.includes(n));
            if (isCodeMatch(naCodes)) return 'North America';
            if (isNameMatch(euroNames)) return 'Europe';
            return 'Other';
        }

        function getCountryName(code) {
            const c = code.toUpperCase();
            const us = ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 
                        'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 
                        'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 
                        'WI', 'WY', 'DC'];
            // CHANGED: Added arrays so Plotly knows which abbreviations belong to Canada and Australia
            const canada = ['AB', 'BC', 'MB', 'NB', 'NL', 'NT', 'NS', 'NU', 'ON', 'PE', 'QC', 'SK', 'YT', 'CANADA', 'CAN'];
            const australia = ['NSW', 'VIC', 'QLD', 'WA(AU)', 'SA', 'TAS', 'ACT', 'NT(AU)', 'AUSTRALIA', 'AUS'];

            if (us.includes(c)) return 'United States';
            if (canada.includes(c)) return 'Canada';
            if (australia.includes(c)) return 'Australia';
            return code; 
        }

        const cleanNum = (val, isRatio) => {
            if (!val) return NaN;
            let num = parseFloat(val.toString().replace(/[%,]/g, ''));
            return isRatio ? num / 100.0 : num;
        };

    

        // CHANGED: processDataForGraph - Replaced silent filtering with a loop that tattletales on bad Focus/Agg formatting
        function processDataForGraph() {
            const minPopVal = parseFloat(document.getElementById('minPop').value) || 0;
            const regionFilter = document.getElementById('regionFilter').value;
            const sliderVal = parseFloat(document.getElementById('sizeSlider').value);
            const scaleFactor = sliderVal / 100.0;
            
            // CHANGED: Replaced the silent filter with a loop that logs unrecognized Focus/Aggregation types
            let filtered = [];
            rawData.forEach(row => {
                const city = row['City/municipality'];
                if (!city) return; // Skip completely empty spreadsheet rows
                
                const f = (row['Focus'] || "").trim().toLowerCase();
                const a = (row['Aggregation'] || "").trim().toLowerCase();
                
                // Tattletale if the spreadsheet has weird values here
                if (f !== 'infrastructure' && f !== 'balanced' && f !== 'destination' && f !== "") {
                    console.warn(`Graph Filter Drop -> ${city}: Unrecognized Focus "${row['Focus']}"`);
                }
                if (a !== 'city wide' && a !== 'best area' && a !== 'highest point' && a !== "") {
                    console.warn(`Graph Filter Drop -> ${city}: Unrecognized Aggregation "${row['Aggregation']}"`);
                }

                if (f === currentFocus.toLowerCase() && a === 'city wide') {
                    filtered.push(row);
                }
            });
            
            const seenCities = new Set();
            filtered = filtered.filter(row => {
                const cityKey = row['City/municipality'] + '|' + row['State/ Country'];
                if (seenCities.has(cityKey)) return false;
                seenCities.add(cityKey);
                return true;
            });

            const processed = [];
            filtered.forEach(row => {
                const pop = cleanNum(row['Population'], false);
                const avgScore = cleanNum(row['Average Score'], false);
                const disparity = cleanNum(row['Disparity'], false);
                
                if (isNaN(avgScore) || isNaN(disparity) || isNaN(pop)) {
                    console.warn(`Graph Data Drop -> ${row['City/municipality']}: Missing Data (Pop: ${pop}, Score: ${avgScore}, Disp: ${disparity})`);
                    return;
                }
                
                if (pop < minPopVal) return;

                const formattedLoc = formatLocation(row['State/ Country']);
                const region = getRegion(formattedLoc);
                if (regionFilter !== 'All' && region !== regionFilter) return;
                
                const infraRatio = cleanNum(row['Infra ratio'], true);
                const destRatio = cleanNum(row['Dest ratio'], true);
                const popBasedSize = Math.pow(pop, 0.33) / 4.2;
                const fixedSize = 10; 
                const finalSize = (fixedSize * (1 - scaleFactor)) + (popBasedSize * scaleFactor);

                processed.push({
                    city: row['City/municipality'],
                    state: formattedLoc,
                    pop: pop,
                    avgScore: avgScore,
                    bestAreaScore: avgScore + disparity,
                    focusBalance: infraRatio - destRatio,
                    sizeScaled: finalSize,
                    region: region,
                    raw: row
                });
            });
                        // Sort by population descending, keep top 40, then re‑sort by scaled size for graphing
            processed.sort((a, b) => b.pop - a.pop);
            processed = processed.slice(0, 40);
            processed.sort((a, b) => b.sizeScaled - a.sizeScaled);
            return processed;
        }

                function processDataForGraph() {
            const minPopVal = parseFloat(document.getElementById('minPop').value) || 0;
            const regionFilter = document.getElementById('regionFilter').value;
            const sliderVal = parseFloat(document.getElementById('sizeSlider').value);
            const scaleFactor = sliderVal / 100.0;
            
            // CHANGED: Replaced the silent filter with a loop that logs unrecognized Focus/Aggregation types
            let filtered = [];
            rawData.forEach(row => {
                const city = row['City/municipality'];
                if (!city) return; // Skip completely empty spreadsheet rows
                
                const f = (row['Focus'] || "").trim().toLowerCase();
                const a = (row['Aggregation'] || "").trim().toLowerCase();
                
                // Tattletale if the spreadsheet has weird values here
                if (f !== 'infrastructure' && f !== 'balanced' && f !== 'destination' && f !== "") {
                    console.warn(`Graph Filter Drop -> ${city}: Unrecognized Focus "${row['Focus']}"`);
                }
                if (a !== 'city wide' && a !== 'best area' && a !== 'highest point' && a !== "") {
                    console.warn(`Graph Filter Drop -> ${city}: Unrecognized Aggregation "${row['Aggregation']}"`);
                }

                if (f === currentFocus.toLowerCase() && a === 'city wide') {
                    filtered.push(row);
                }
            });
            
            const seenCities = new Set();
            filtered = filtered.filter(row => {
                const cityKey = row['City/municipality'] + '|' + row['State/ Country'];
                if (seenCities.has(cityKey)) return false;
                seenCities.add(cityKey);
                return true;
            });

            const processed = [];
            filtered.forEach(row => {
                const pop = cleanNum(row['Population'], false);
                const avgScore = cleanNum(row['Average Score'], false);
                const disparity = cleanNum(row['Disparity'], false);
                
                if (isNaN(avgScore) || isNaN(disparity) || isNaN(pop)) {
                    console.warn(`Graph Data Drop -> ${row['City/municipality']}: Missing Data (Pop: ${pop}, Score: ${avgScore}, Disp: ${disparity})`);
                    return;
                }
                
                if (pop < minPopVal) return;

                const formattedLoc = formatLocation(row['State/ Country']);
                const region = getRegion(formattedLoc);
                if (regionFilter !== 'All' && region !== regionFilter) return;
                
                const infraRatio = cleanNum(row['Infra ratio'], true);
                const destRatio = cleanNum(row['Dest ratio'], true);
                const popBasedSize = Math.pow(pop, 0.33) / 4.2;
                const fixedSize = 10; 
                const finalSize = (fixedSize * (1 - scaleFactor)) + (popBasedSize * scaleFactor);

                processed.push({
                    city: row['City/municipality'],
                    state: formattedLoc,
                    pop: pop,
                    avgScore: avgScore,
                    bestAreaScore: avgScore + disparity,
                    focusBalance: infraRatio - destRatio,
                    sizeScaled: finalSize,
                    region: region,
                    raw: row
                });
            });
            processed.sort((a, b) => b.sizeScaled - a.sizeScaled);
            return processed;
        }
		
		function updateView() {
            if (rawData.length === 0) return;
            if (currentView === 'graph') updatePlot();
            else if (currentView === 'map') updateMap();
            else updateList();
        }


        function updateMap() {
            const mapLevel = document.getElementById('mapLevel').value;
            const aggMode = document.getElementById('aggFilter').value; 
            // Build the focus label: only add if not Balanced
			const focusLabel = currentFocus === 'Balanced' ? '' : ` (${currentFocus} Focus)`;
            // CHANGED: Build a normalized dictionary on the fly that ignores ALL spaces, capitalization, and punctuation
            const NORMALIZED_COORDS = {};
            Object.keys(CITY_COORDS).forEach(key => {
                const cleanKey = key.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                NORMALIZED_COORDS[cleanKey] = CITY_COORDS[key];
                
                // Map the city-only part as a fallback
                const cityPart = key.split(',')[0].replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                if (!NORMALIZED_COORDS[cityPart]) NORMALIZED_COORDS[cityPart] = CITY_COORDS[key];
            });

            const baseData = processDataForList('City Wide');
            const targetData = (aggMode === 'Best Area') ? processDataForList('Best Area') : baseData;
            
            const data = targetData;
            const plotConfig = { responsive: true, scrollZoom: true };
            
            const getScore = (d) => {
                if (aggMode === 'Highest Point') return parseFloat(d.raw['Highest Point']) || 0;
                if (aggMode === 'City Wide') return d.avgScore;
                return d.bestAreaScore;
            };

            data.sort((a, b) => getScore(a) - getScore(b));
            
            if (mapLevel === 'City') {
                const lats = [], lons = [], sizes = [], colors = [], customdata = [], texts = [];
                data.forEach(d => {
                    let lat = parseFloat(d.raw['Latitude'] || d.raw['lat']);
                    let lon = parseFloat(d.raw['Longitude'] || d.raw['lon']);
                    
                    let lookupKey = (d.city || "").trim() + ", " + (d.state || "").trim();

                    // CHANGED: Now checks if EITHER latitude or longitude is NaN to trigger the fallback dictionary lookup
                    if (isNaN(lat) || isNaN(lon)) {
                        // CHANGED: Strip everything but letters and numbers from the CSV strings to guarantee a match
                        let cleanLookup = ((d.city || "") + (d.state || "")).replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                        let cleanCityOnly = (d.city || "").replace(/[^a-zA-Z0-9]/g, '').toLowerCase();

                        // Match against our bulletproof normalized dictionary
                        let match = NORMALIZED_COORDS[cleanLookup] || NORMALIZED_COORDS[cleanCityOnly];

                        if (match) {
                            lat = match.lat;
                            lon = match.lon;
                        }
                    }

                    if (!isNaN(lat) && !isNaN(lon)) {
                        lats.push(lat);
                        lons.push(lon);
                        sizes.push(Math.pow(d.pop, 0.25) / 4 + 4);
                        
                        let score = getScore(d);
                        colors.push(score);
                        texts.push(d.city);
                        
                        customdata.push([
                            d.pop.toLocaleString(), 
                            d.avgScore, 
                            d.bestAreaScore, 
                            d.focusDisparity || 0,
                            parseFloat(d.raw['Highest Point']) || 0,
                            d.state 
                        ]);
                    } else {
                        console.warn(`Map Coordinates Drop -> ${d.city}, ${d.state}: No coordinates found in CSV or Dictionary! (Looked for: "${lookupKey}")`);
                    }
                });

                Plotly.react('map-container', [{
                    type: 'scattergeo', mode: 'markers',
                    lat: lats, lon: lons, text: texts,
                    customdata: customdata,
                    marker: {
                        size: sizes, color: colors, 
                        colorscale: CUSTOM_COLORSCALE,
                        cmin: 0, cmax: 100, 
                        colorbar: { title: aggMode + '<br>Score', x: 0.98 },
                        line: { color: 'black', width: 0.5 }, opacity: 0.9
                    },
                    hovertemplate: 
                        "<b>%{text}</b><br>" +
                        "%{customdata[5]}<br><br>" +
                        "Pop: %{customdata[0]}<br>" +
                        "City Score: %{customdata[1]:.1f}<br>" +
                        "Best Area: %{customdata[2]:.1f}<br>" +
                        "Highest Point: %{customdata[4]:.1f}<br>" +
                        "Focus Disp: %{customdata[3]:.1f}<extra></extra>"
                }], {
                    title: `City Scores ("${aggMode}")${focusLabel}`,
                    uirevision: 'true',
                    geo: { 
                        domain: { x: [0, 0.98] },
                        scope: 'world', projection: { type: 'natural earth', scale: currentMapScale },
                        showland: true, landcolor: 'lightgray', 
                        showocean: true, oceancolor: 'lightblue',
                        showlakes: true, lakecolor: 'lightblue',
                        showcountries: true, countrycolor: '#888', countrywidth: 1,
                        showsubunits: true, subunitcolor: '#ccc', subunitwidth: 0.5
                    },
                    margin: { l:0, r:80, t:50, b:0 }
                }, plotConfig); 
            } 
            else {
                // CHOROPLETH (Hybrid or Country)
                const worldAgg = {};
                const usAgg = {};
                const canAgg = {};
                const ausAgg = {};
                
                const edgeAgg = {};

                const CAN_NAMES = {
                    'AB': 'Alberta', 'BC': 'British Columbia', 'MB': 'Manitoba', 'NB': 'New Brunswick',
                    'NL': 'Newfoundland and Labrador', 'NT': 'Northwest Territories', 'NS': 'Nova Scotia',
                    'NU': 'Nunavut', 'ON': 'Ontario', 'PE': 'Prince Edward Island', 'QC': 'Quebec',
                    'SK': 'Saskatchewan', 'YT': 'Yukon'
                };
                const AUS_NAMES = {
                    'NSW': 'New South Wales', 'VIC': 'Victoria', 'QLD': 'Queensland',
                    'WA(AU)': 'Western Australia', 'SA': 'South Australia', 'TAS': 'Tasmania',
                    'ACT': 'Australian Capital Territory', 'NT (AU)': 'Northern Territory'
                };
                
                data.forEach(d => {
                    const country = getCountryName(d.state);
                    const cleanCountry = country.trim().toUpperCase();
                    
                    const score = getScore(d);
                    const highestPoint = parseFloat(d.raw['Highest Point']) || 0;
                    
                    const aggObj = {
                        score: score, 
                        bestCity: d.city, 
                        bestCityScore: d.avgScore, 
                        bestAreaScore: d.bestAreaScore,
                        highestPoint: highestPoint
                    };

                    if (cleanCountry === 'KOSOVO') {
                        if (!edgeAgg['Kosovo'] || score > edgeAgg['Kosovo'].score) edgeAgg['Kosovo'] = aggObj;
                    } else if (cleanCountry === 'SOMALILAND') {
                        if (!edgeAgg['Somaliland'] || score > edgeAgg['Somaliland'].score) edgeAgg['Somaliland'] = aggObj;
                    } else if (mapLevel === 'State' && cleanCountry === 'UNITED STATES') {
                       // Skip US for world overlay
                    } else if (mapLevel === 'State' && cleanCountry === 'CANADA') {
                       // Skip Canada for world overlay
                    } else if (mapLevel === 'State' && cleanCountry === 'AUSTRALIA') {
                       // Skip Australia for world overlay
                    } else {
                       if (!worldAgg[country] || score > worldAgg[country].score) {
                           worldAgg[country] = aggObj;
                       }
                    }

                    if (mapLevel === 'State') {
                        if (cleanCountry === 'UNITED STATES' && d.state.length === 2) { 
                            if (!usAgg[d.state] || score > usAgg[d.state].score) usAgg[d.state] = aggObj;
                        } 
                        else if (cleanCountry === 'CANADA') {
                            const fullName = CAN_NAMES[d.state] || d.state;
                            if (!canAgg[fullName] || score > canAgg[fullName].score) canAgg[fullName] = aggObj;
                        }
                        else if (cleanCountry === 'AUSTRALIA') {
                            const fullName = AUS_NAMES[d.state] || d.state;
                            if (!ausAgg[fullName] || score > ausAgg[fullName].score) ausAgg[fullName] = aggObj;
                        }
                    }
                });

                const traces = [];

                const worldLocs = Object.keys(worldAgg);
                if (worldLocs.length > 0) {
                    traces.push({
                        type: 'choropleth',
                        locationmode: 'country names',
                        locations: worldLocs,
                        z: worldLocs.map(k => worldAgg[k].score),
                        customdata: worldLocs.map(k => [worldAgg[k].bestCity, worldAgg[k].bestCityScore, worldAgg[k].bestAreaScore, worldAgg[k].highestPoint]),
                        text: worldLocs, 
                        colorscale: CUSTOM_COLORSCALE,
                        zmin: 0, zmax: 100,
                        marker: { line: { color: 'rgb(255,255,255)', width: 1 } },
                        colorbar: { title: aggMode + '<br>Score', x: 0.98 },
                        hovertemplate: "<b>%{location}</b><br>Best City: %{customdata[0]}<br>City Score: %{customdata[1]:.1f}<br>Best Area: %{customdata[2]:.1f}<br>Highest Point: %{customdata[3]:.1f}<extra></extra>"
                    });
                }

                if (mapLevel === 'State' && Object.keys(usAgg).length > 0) {
                    const usLocs = Object.keys(usAgg);
                    traces.push({
                        type: 'choropleth',
                        locationmode: 'USA-states',
                        locations: usLocs,
                        z: usLocs.map(k => usAgg[k].score),
                        customdata: usLocs.map(k => [usAgg[k].bestCity, usAgg[k].bestCityScore, usAgg[k].bestAreaScore, usAgg[k].highestPoint]),
                        text: usLocs,
                        colorscale: CUSTOM_COLORSCALE,
                        zmin: 0, zmax: 100,
                        marker: { line: { color: 'rgb(255,255,255)', width: 1 } },
                        showscale: false,
                        hovertemplate: "<b>%{location}</b><br>Best City: %{customdata[0]}<br>City Score: %{customdata[1]:.1f}<br>Best Area: %{customdata[2]:.1f}<br>Highest Point: %{customdata[3]:.1f}<extra></extra>"
                    });
                }

                if (mapLevel === 'State' && Object.keys(canAgg).length > 0) {
                    const canLocs = Object.keys(canAgg);
                    traces.push({
                        type: 'choropleth',
                        locationmode: 'geojson-id',
                        geojson: 'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/canada.geojson',
                        locations: canLocs,
                        featureidkey: 'properties.name', 
                        z: canLocs.map(k => canAgg[k].score),
                        customdata: canLocs.map(k => [canAgg[k].bestCity, canAgg[k].bestCityScore, canAgg[k].bestAreaScore, canAgg[k].highestPoint]),
                        text: canLocs,
                        colorscale: CUSTOM_COLORSCALE,
                        zmin: 0, zmax: 100,
                        marker: { line: { color: 'rgb(255,255,255)', width: 1 } },
                        showscale: false,
                        hovertemplate: "<b>%{location}</b><br>Best City: %{customdata[0]}<br>City Score: %{customdata[1]:.1f}<br>Best Area: %{customdata[2]:.1f}<br>Highest Point: %{customdata[3]:.1f}<extra></extra>"
                    });
                }

                if (mapLevel === 'State' && Object.keys(ausAgg).length > 0) {
                    const ausLocs = Object.keys(ausAgg);
                    traces.push({
                        type: 'choropleth',
                        locationmode: 'geojson-id',
                        geojson: 'https://raw.githubusercontent.com/rowanhogan/australian-states/master/states.geojson',
                        locations: ausLocs,
                        featureidkey: 'properties.STATE_NAME', 
                        z: ausLocs.map(k => ausAgg[k].score),
                        customdata: ausLocs.map(k => [ausAgg[k].bestCity, ausAgg[k].bestCityScore, ausAgg[k].bestAreaScore, ausAgg[k].highestPoint]),
                        text: ausLocs,
                        colorscale: CUSTOM_COLORSCALE,
                        zmin: 0, zmax: 100,
                        marker: { line: { color: 'rgb(255,255,255)', width: 1 } },
                        showscale: false,
                        hovertemplate: "<b>%{location}</b><br>Best City: %{customdata[0]}<br>City Score: %{customdata[1]:.1f}<br>Best Area: %{customdata[2]:.1f}<br>Highest Point: %{customdata[3]:.1f}<extra></extra>"
                    });
                }

                if (Object.keys(edgeAgg).length > 0) {
                    const edgeLocs = Object.keys(edgeAgg);
                    traces.push({
                        type: 'choropleth',
                        locationmode: 'geojson-id',
                        geojson: 'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json',
                        locations: edgeLocs,
                        featureidkey: 'properties.name', 
                        z: edgeLocs.map(k => edgeAgg[k].score),
                        customdata: edgeLocs.map(k => [edgeAgg[k].bestCity, edgeAgg[k].bestCityScore, edgeAgg[k].bestAreaScore, edgeAgg[k].highestPoint]),
                        text: edgeLocs,
                        colorscale: CUSTOM_COLORSCALE,
                        zmin: 0, zmax: 100,
                        marker: { line: { color: 'rgb(255,255,255)', width: 1 } },
                        showscale: false,
                        hovertemplate: "<b>%{location}</b><br>Best City: %{customdata[0]}<br>City Score: %{customdata[1]:.1f}<br>Best Area: %{customdata[2]:.1f}<br>Highest Point: %{customdata[3]:.1f}<extra></extra>"
                    });
                }

					

				Plotly.react('map-container', traces, {
					// Updated: Changed (Hybrid Data) to By Country/Region and added dynamic focusLabel
					title: mapLevel === 'Country' 
						? `Highest "${aggMode}" Score by Country${focusLabel}` 
						: `Highest "${aggMode}" Score By Country/Region${focusLabel}`,
                    uirevision: 'true',
                    geo: { 
                        domain: { x: [0, 0.98] },
                        scope: 'world', 
                        projection: { type: 'natural earth', scale: currentMapScale },
                        showland: true, landcolor: 'lightgray',
                        showocean: true, oceancolor: 'lightblue',
                        showlakes: true, lakecolor: 'lightblue'
                    },
                    margin: { l:0, r:80, t:50, b:0 }
                }, plotConfig); 
            }
            
            attachMapLock();
        }
        
        // CHANGED: Clean map locker without timeouts to stop the stuttering
        function attachMapLock() {
            const mapDiv = document.getElementById('map-container');
            
            // Prevent multiple listeners from stacking
            if (mapDiv._hasRelayoutListener) return;

            mapDiv.on('plotly_relayout', function(eventData) {
                let update = {};
                let needsUpdate = false;

                // 1. Zoom Clamping (Between 1 and 150)
                if (eventData['geo.projection.scale'] !== undefined) {
                    let newScale = eventData['geo.projection.scale'];
                    if (newScale < 1) { 
                        update['geo.projection.scale'] = 1; 
						// NEW: Force vertical center back to '0' to stop the jumping effect
						update['geo.center.lat'] = 0;
                        needsUpdate = true; 
                    }
                    else if (newScale > 150) { 
                        update['geo.projection.scale'] = 150; 
                        needsUpdate = true; 
                    }
                    // Update our tracker even if it wasn't clamped
                    currentMapScale = update['geo.projection.scale'] || newScale;
                }

                // 2. Latitude Clamping (Reduced limits for tighter control)
				// Only apply this if we aren't already resetting the center from the zoom check
				if (eventData['geo.center.lat'] !== undefined && update['geo.center.lat'] === undefined) {
					let newLat = eventData['geo.center.lat'];
					if (newLat > 50) { update['geo.center.lat'] = 50; needsUpdate = true; }
					if (newLat < -50) { update['geo.center.lat'] = -50; needsUpdate = true; }
				}

                // If they hit a boundary, rigidly snap them back
                if (needsUpdate) {
                    Plotly.relayout(mapDiv, update);
                }
            });
            
            mapDiv._hasRelayoutListener = true;
        }
		
        // --- GRAPH & LIST UPDATE FUNCTIONS ---
        function updatePlot() {
            let allData = processDataForGraph();
            const title = document.getElementById('graphTitle').value;
            const forceCircle = document.getElementById('forceCircle').checked;
            
            const annotations = [];
            if (currentLabelMode !== 'None') {
                let labelData = [...allData];
                if (currentLabelMode === 'Pop') labelData.sort((a, b) => b.pop - a.pop);
                else labelData.sort((a, b) => b.avgScore - a.avgScore);
                
                labelData.slice(0, 60).forEach(d => {
                    annotations.push({
                        x: d.avgScore, y: d.bestAreaScore, text: d.city,
                        showarrow: false, yshift: (d.sizeScaled / 2) + 8,
                        font: { size: 11, color: '#333' },
                        bgcolor: 'rgba(255, 255, 255, 0.7)', borderpad: 2
                    });
                });
            }

            const traces = [];
            const regions = ['North America', 'Europe', 'Other'];
            const symbolMap = { 'North America': 'star', 'Europe': 'circle', 'Other': 'square' };

            traces.push({
                x: [null], y: [null], mode: 'markers', showlegend: false,
                marker: {
                    colorscale: [[0, 'blue'], [0.5, 'gray'], [1, 'green']],
                    cmin: -0.2, cmax: 0.2, showscale: true,
                    colorbar: { title: 'Dest (Blue) <-> Infra (Green)', len: 0.5, y: 0.25, yanchor: 'bottom' }
                }
            });

            regions.forEach(region => {
                const regionData = allData.filter(d => d.region === region);
                if (regionData.length === 0) return;
                const symbol = forceCircle ? 'circle' : (symbolMap[region] || 'circle');

                traces.push({
                    name: region, x: [null], y: [null], mode: 'markers',
                    legendgroup: region, showlegend: true,
                    marker: { symbol: symbol, color: 'gray', size: 10 }
                });

                traces.push({
                    name: region, x: regionData.map(d => d.avgScore), y: regionData.map(d => d.bestAreaScore),
                    mode: 'markers', type: 'scatter', legendgroup: region, showlegend: false,
                    marker: {
                        symbol: symbol, sizemode: 'diameter', size: regionData.map(d => d.sizeScaled),
                        color: regionData.map(d => d.focusBalance),
                        colorscale: [[0, 'blue'], [0.5, 'gray'], [1, 'green']],
                        cmin: -0.2, cmax: 0.2, showscale: false,
                        opacity: 0.85, line: { width: 1.5, color: 'white' }
                    },
                    customdata: regionData.map(d => [d.state, d.pop]),
                    hovertemplate: "<b>%{hovertext}</b><br>Loc: %{customdata[0]}<br>Pop: %{customdata[1]}<br>Avg Score: %{x:.1f}<br>Best Area: %{y:.1f}<extra></extra>",
                    hovertext: regionData.map(d => d.city)
                });
            });

            Plotly.react('chart-container', traces, {
                title: title, xaxis: { title: "City Wide Score", range:[24,108] }, yaxis: { title: "Best Area Score", range:[24,108] },
                template: "plotly_white", margin: { l:60, r:40, t:80, b:60 }, height: 750,
                uirevision: 'true', // CHANGED: Prevents graph zoom reset
				legend: { title: { text: forceCircle ? '' : 'Region' } },
                annotations: annotations
			}, { responsive: true }); // CHANGED: Added config for responsiveness
        }

        function updateList() {
            const container = document.getElementById('listGrid');
            container.innerHTML = ''; 
            const aggMode = document.getElementById('aggFilter').value; 
            const baseData = processDataForList('City Wide');
            const targetData = (aggMode === 'City Wide') ? baseData : processDataForList('Best Area');

            const createCard = (config) => {
                let displayData = [...config.data];
                displayData = displayData.filter(d => {
                    let val = (config.key==='bestAreaScore') ? d.bestAreaScore : (config.key==='avgScore') ? d.avgScore : (config.key==='focusDisparity') ? d.focusDisparity : (d.raw[config.key]!==undefined ? d.raw[config.key] : d[config.key]);
                    return (val !== null && val !== undefined && val !== '' && !(typeof val==='number' && isNaN(val)));
                });
                
                displayData.sort((a, b) => {
                    let valA = parseFloat(a.raw[config.key]) || (config.key==='bestAreaScore'?a.bestAreaScore:config.key==='focusDisparity'?a.focusDisparity:parseFloat(a[config.key]))||0;
                    let valB = parseFloat(b.raw[config.key]) || (config.key==='bestAreaScore'?b.bestAreaScore:config.key==='focusDisparity'?b.focusDisparity:parseFloat(b[config.key]))||0;
                    return config.reverse ? valA - valB : valB - valA;
                });
                displayData = displayData.slice(0, 25);

                const card = document.createElement('div');
                card.className = 'list-card';
                
                let headerContent = config.title;
                if (config.type === 'stat') {
                    const options = ["Safe Area (sq mi)", "Bike Network (mi)", "Bike Network %", "Bike Paths (mi)", "Bike Paths %", "Bike Lanes (mi)", "Bike Lanes %", "Friendly (mi)", "Friendly %", "Shared Road (miles)", "Shared Road %", "Other (miles)", "Other %", "Total Network", "Destinations", "Bike Parking", "Destination Score", "Bad Ints  / mi", "Furthest Reach #1", "Furthest Reach #2", "Furthest Reach #3"];
                    let selectHtml = `<select onchange="updateStat(this.value)">` + options.map(o => `<option value="${o}" ${o===currentIndivStat?'selected':''}>${o}</option>`).join('') + `</select>`;
                    headerContent = `Stat: <div style="display:flex; align-items:center;">${selectHtml}<button class="sort-btn" onclick="toggleStatSort()">${statReverse ? "▲ Btm 25" : "▼ Top 25"}</button></div>`;
                } else if (config.type === 'neighborDisp') {
                    headerContent = `${config.title} <div style="display:flex;"><button class="sort-btn ${!neighborDispReverse?'active-sort':''}" onclick="toggleNeighborDisp('largest')">Largest</button><button class="sort-btn ${neighborDispReverse?'active-sort':''}" onclick="toggleNeighborDisp('smallest')">Smallest</button></div>`;
                } else if (config.type === 'focusDisp') {
                    headerContent = `${config.title} <div style="display:flex;"><button class="sort-btn ${!focusDispReverse?'active-sort':''}" onclick="toggleFocusDisp('infra')">Infra Heavy</button><button class="sort-btn ${focusDispReverse?'active-sort':''}" onclick="toggleFocusDisp('dest')">Dest Heavy</button></div>`;
                } else if (config.type === 'pfb') {
                    headerContent = `${config.title} <div style="display:flex;"><button class="sort-btn ${pfbReverse?'active-sort':''}" onclick="togglePFB('overrated')">Overrated</button><button class="sort-btn ${!pfbReverse?'active-sort':''}" onclick="togglePFB('underrated')">Underrated</button></div>`;
                } else if (config.type === 'copenhagen') {
                    headerContent = `${config.title} <div style="display:flex;"><button class="sort-btn ${copenhagenReverse?'active-sort':''}" onclick="toggleCopenhagen('overrated')">Overrated</button><button class="sort-btn ${!copenhagenReverse?'active-sort':''}" onclick="toggleCopenhagen('underrated')">Underrated</button></div>`;
                }

                let html = `<h3>${headerContent}</h3><table class="ranking-table">`;
                displayData.forEach((d, i) => {
                    let val = (config.key==='bestAreaScore') ? d.bestAreaScore : (config.key==='avgScore') ? d.avgScore : (config.key==='focusDisparity') ? d.focusDisparity : (d.raw[config.key]!==undefined ? d.raw[config.key] : d[config.key]);
                    if (val === undefined || val === null) val = '-';
                    else {
                        if (config.type === 'stat') val = (typeof val==='number') ? (Math.round(val*10)/10).toFixed(1) : val;
                        else if (config.type === 'focusDisp') val = Math.abs(Math.round(val));
                        else val = Math.round(val);
                    }
                    html += `<tr><td class="rank-col">${i+1}</td><td><div>${d.city}</div><div class="city-sub">${d.state}</div></td><td class="val-col">${val}</td></tr>`;
                });
                html += `</table>`;
                card.innerHTML = html;
                container.appendChild(card);
            };

            createCard({ title: "Citywide Scores", data: baseData, key: 'Average Score', reverse: false });
            createCard({ title: "Best Area Scores", data: baseData, key: 'bestAreaScore', reverse: false });
            createCard({ title: "Highest Points", data: targetData, key: 'Highest Point', reverse: false });
            createCard({ title: "Stat", data: targetData, key: currentIndivStat, reverse: statReverse, type: 'stat' });
            createCard({ title: "Neighborhood Disparities", data: targetData, key: 'Disparity', reverse: neighborDispReverse, type: 'neighborDisp' });
            createCard({ title: "Focus Disparities", data: targetData, key: 'focusDisparity', reverse: focusDispReverse, type: 'focusDisp' });
            createCard({ title: "PFB Rankings", data: targetData, key: 'PFB rank dif', reverse: pfbReverse, type: 'pfb' });
            createCard({ title: "Copenhagen Rankings", data: targetData, key: 'Copenhagen rank dif', reverse: copenhagenReverse, type: 'copenhagen' });
        }
    </script>
</body>
</html>
